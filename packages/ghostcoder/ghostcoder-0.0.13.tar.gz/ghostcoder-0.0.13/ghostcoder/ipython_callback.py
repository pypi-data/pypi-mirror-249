import time

from IPython.core.display import HTML, Markdown
from IPython.core.display_functions import display, update_display

from ghostcoder.schema import Message, TextItem

ghost_img = '<img alt="ðŸ‘»" class="imga" width="25" height="25" src="data:image/png;base64,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">'
ai_img = '<img alt="ðŸ¤–" class="imga" width="25" height="25" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAABICAMAAABiM0N1AAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAJGUExURUdwTJaztgQ4RK/HwXBEOJ22s0lJTgQ3Qqaxr7PLxGABAfmHKSNNXhlPXK3GwWIJCa7HwUlre7DIwRVQXEBrdPyNHvyJCFF5iIQeHf2MGP2WNrELCwU6RxJIVTxLUohlgarDvqQODgpATG0QEXsGBo4AAO4bHP2QATFPWDRdZ4tvqcMqKfQXF7KppnmKieGGRbWbmJi4tCR+jd3299/4+Nr09GSXoBx9jCaDkVmTnQA3RAAzQNv19rfOxyN9i+r9/a/Gv2qbogRBT8LZ1VsCAV+VnQA5R0qKmHGfpVKMl1ePmdTz8Epzenikqu3y9CJXYM7u6jB/juH7+kaFkzaBj5a7vT6FkqXKzcTk4SJ1ka7R1nursI22uXhoZfH//oSvsgD3/ThlbLzBuCt8jLnTznFXiCFqgrna25jCyNf59RNXZQxLVyN8l8/h4j02NWBZWf39/nWTkz0sSd3n5wDg/WiHiIlwsiKPvzNthBxlcpqYkYekov57AFuAhD91iabCvujw6lpBbSFzhy8tLM9nZu1WU3AxMv2NAYVqoztBQxqe05myrgK66ji9w//KAMZbWRgVFf/oOv/4g5OFgvsKB/w5NP6uB191dxe6xeQ4NMvSyGIODZ2fmowyMou7xssiHsRmO6+yq68+PCIfH7FIRrBhWfiFg7Fzcf1lYx7R1ADj5f+iBv+0NgcCBHEeHEueyQKd03esyGGitlCkrfyTkf/0sf//yv+rqhEOD991dP/VeemFhA4KC+x2dTOeqBMSEuG4tP/RRHnCQhgAAACodFJOUwAo9IwPXP5WB/5YHkKHbrirct28nZXXU427TlLkpSu4ubTTrLhYqPLyz++Rw8B/69fy/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////rntjMIAAAdzSURBVFjD5Zj7X1J5GsczzZFN3TS1y3TbZrfmuj/I0UHgeBASSFAIxMNVRAmIi4jKKpJikFtqbc6YmffN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">'
human_img = '<img alt="ðŸ§‘" class="imga"width="25" height="25" src="data:image/png;base64,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">'

class DisplayCallback:

    def __init__(self, display_id: str = None):

        self.display_id = display_id
        self.text = ""

    def ai_stream(self, token: str):
        if not self.display_id:
            self.display_id = str(time.time())
            self.text = token
            display(HTML(ai_img))
            display(Markdown(self.text), display_id=self.display_id)
        else:
            self.text += self.text

        update_display(Markdown(self.text), display_id=self.display_id)

    def display_gc(self, message: str):
        self.display("Ghostcoder", message)

    def display(self, sender: str, message: str):
        self.display_message(Message(sender=sender, items=[TextItem(text=message)]))

    def display_message(self, message: Message):
        if self.display_id:
            update_display("", display_id=self.display_id)
        elif message.role == "AI":
            update_display(Markdown(message), display_id=self.display_id)

        if message.role == "Ghostcoder":
            display(HTML(ghost_img))
        elif message.role == "Human":
            display(HTML(human_img))

        for item in message.items:
            if item.type == "file" and message.role == "Human":
                content = f"File: `{item.file_path}`"
                display(Markdown(content))
            elif item.type.endswith("file"):
                content = f"File: `{item.file_path}`:\n```{item.language}\n{item.content}\n```"
                display(Markdown(content))
            else:
                display(Markdown(item.to_prompt()))

        self.display_id = None
