<!DOCTYPE html>
<html>
    <head>
        <title>Xleb</title>
        <meta charset="UTF-8">
        <meta name="description" content="web-based file manager">
        <meta name="keywords" content="python, remote access, file manager, web">
        <meta name="author" content="bitrate16">
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" type="image/png" href="/media/favicon.png">
        <link rel="stylesheet" href="/css/common.css">
        <style>

        </style>
    </head>
    <body>
        <div class="progress-popup" id="progress-popup" style="display: none;">
            <div class="content horisontal">
                <div class="vertical">
                    <div class="spinner"></div>
                    <div class="text" id="progress-popup-text">0%</div>
                </div>
            </div>
        </div>
        <div class="file-list" id="file-list" class="vertical gap" style="align-items: flex-start; flex-wrap: wrap;">
        </div>
        <script type="text/javascript">
            (function () {
                'use strict';

                var app = {};

                // Get page params
                app.searchParams = new URL(window.location).searchParams;
                app.path = app.searchParams.get('path') || '/';
                app.uploading = false;

                // Trim leading
                while (app.path.length > 1 && app.path[0] === '/') {
                    app.path = app.path.slice(1);
                }

                // Trim trailing
                while (app.path.length > 1 && app.path[app.length - 1] === '/') {
                    app.path = app.path.slice(0, -1);
                }

                /**
                 * Get current page host
                 *
                 * @returns {String}
                 */
                function getSelfUrl() {
                    var url = new URL(window.location);
                    url.pathname = '';
                    url.search = '';
                    url = url.toString();
                    return url.endsWith('/') ? url.slice(0, -1) : url;
                }
                app.selfUrl = getSelfUrl();


                /* API things */

                /**
                 * Fetch list of files
                 */
                function fetchFilesList() {
                    return new Promise((resolve, reject) => {
                        fetch(
                            `${ app.selfUrl }/list?path=${ encodeURIComponent(app.path) }`,
                            {
                                'credentials': 'include',
                            }
                        )
                        .then(async (response) => {
                            if (response.status !== 200) {
                                alert(response.statusText);
                                resolve([]);
                            } else {
                                var json = await response.json();

                                // Error
                                if (json.error) {
                                    console.error(json.error);
                                    alert(json.error);
                                    resolve([]);
                                    return;
                                }

                                // Fine
                                resolve(json['files']);
                            }
                        })
                        .catch((error) => {
                            console.error(error);
                            alert(error);
                            resolve([]);
                        })
                    });
                }


                // ref: https://stackoverflow.com/a/5723274
                function truncate (fullStr, strLen, separator) {
                    if (fullStr.length <= strLen) return fullStr;

                    separator = separator || '...';

                    var sepLen = separator.length,
                        charsToShow = strLen - sepLen,
                        frontChars = Math.ceil(charsToShow/2),
                        backChars = Math.floor(charsToShow/2);

                    return fullStr.substr(0, frontChars) +
                        separator +
                        fullStr.substr(fullStr.length - backChars);
                };

                // ref: https://stackoverflow.com/a/14919494
                function humanFileSize (bytes, si=false, dp=1) {
                    const thresh = si ? 1000 : 1024;

                    if (Math.abs(bytes) < thresh) {
                        return bytes + ' B';
                    }

                    const units = si
                        ? ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']
                        : ['KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB'];
                    let u = -1;
                    const r = 10**dp;

                    do {
                        bytes /= thresh;
                        ++u;
                    } while (Math.round(Math.abs(bytes) * r) / r >= thresh && u < units.length - 1);


                    return bytes.toFixed(dp) + ' ' + units[u];
                }

                /**
                 * Add new file entry in list
                 *
                 * @param item {Object}
                 */
                function addFileItem(item) {
                    // skip
                    if (!item) {
                        return;
                    }

                    var fileListElement = document.getElementById('file-list');

                    // technical
                    if (item.name === '..') {

                        // List item container
                        var itemElement = document.createElement('div');
                        itemElement.classList = 'item';

                        // Skip rootdir
                        if (app.path !== '/') {

                            // Up mark
                            var itemTypeElement = document.createElement('div');
                            itemTypeElement.classList = 'type nav';
                            itemTypeElement.textContent = '^';
                            itemElement.appendChild(itemTypeElement);

                            var pathSplit = app.path.split('/').slice(0, -1).join('/');
                            if (!pathSplit) {
                                pathSplit = '/';
                            } else if (pathSplit[0] !== '/') {
                                pathSplit = '/' + pathSplit;
                            }

                            // File with download
                            var itemNameElement = document.createElement('a');
                            itemNameElement.classList = 'name';
                            itemNameElement.href = `${ app.selfUrl }/?path=${ encodeURIComponent(pathSplit) }`;
                            itemNameElement.target = '_self';
                            itemNameElement.textContent = item.name;
                            itemElement.appendChild(itemNameElement);
                        }

                        // Upload button
                        var itemUploadElement = document.createElement('div');
                        itemUploadElement.classList = 'upload fine-button green';
                        itemUploadElement.addEventListener('click', function (event) {
                            if (event.button === 0) {
                                // Prevent parallel (how?)
                                if (app.uploading) {
                                    return;
                                }

                                // Pick file
                                var input = document.createElement('input');
                                input.type = 'file';

                                // Handle selection done
                                input.onchange = e => {

                                    // Special element with file upload info
                                    var progressPopup = document.getElementById('progress-popup');
                                    progressPopup.style.display = null;

                                    var progressPopupText = document.getElementById('progress-popup-text');

                                    // Uploading started
                                    app.uploading = true;

                                    // Create form
                                    var file = e.target.files[0];
                                    var formdata = new FormData();
                                    formdata.append('file', file);

                                    var request = new XMLHttpRequest();

                                    // Track progress
                                    request.upload.addEventListener('progress', function (e) {
                                        var fileSize = file.size;

                                        if (e.loaded <= fileSize) {
                                            var percent = Math.round(e.loaded / fileSize * 100);
                                            progressPopupText.textContent = percent + '%';
                                        }

                                        if (e.loaded == e.total){
                                            progressPopupText.textContent = '100%';
                                        }
                                    });

                                    // Handler finish (error or success)
                                    request.addEventListener('readystatechange', function (event) {
                                        if (request.readyState === XMLHttpRequest.DONE) {
                                            progressPopup.style.display = 'none';
                                            app.uploading = false;

                                            window.location.reload();
                                        }
                                    })

                                    // POST
                                    request.open('POST', `${ app.selfUrl }/upload?path=${ encodeURIComponent(app.path) }`);
                                    request.send(formdata);
                                }

                                // Trigger selection
                                input.click();
                            }
                        })
                        itemUploadElement.textContent = 'upload file';
                        itemElement.appendChild(itemUploadElement);

                        // Create directory button
                        var itemMkdirElement = document.createElement('div');
                        itemMkdirElement.classList = 'mkdir fine-button';
                        itemMkdirElement.addEventListener('click', function (event) {
                            var name = prompt(`Which one?`);
                            if (!name) {
                                return;
                            }

                            name = name.trim();
                            if (!name || name === app.path) {
                                return
                            }

                            // Validate
                            if (!/^(?!^(?:PRN|AUX|CLOCK\$|NUL|CON|COM\d|LPT\d)(?:\..+)?$)(?:\.*?(?!\.))[^\x00-\x1f\\?*:\";|\/<>]+(?<![\s.])$/.test(name)) {
                                alert(`Invalid directory name "${ name }"`);
                                return;
                            }

                            if (event.button === 0) {
                                fetch(
                                    `${ app.selfUrl }/mkdir?path=${ encodeURIComponent(app.path) }&name=${ encodeURIComponent(name) }`,
                                    {
                                        'credentials': 'include',
                                    }
                                )
                                .then(async (response) => {
                                    if (response.status !== 200) {
                                        alert(response.statusText);
                                    } else {
                                        var json = await response.json();

                                        // Error
                                        if (json.error) {
                                            console.error(json.error);
                                            alert(json.error);
                                            return;
                                        }

                                        // Remove self
                                        updateFiles();
                                    }
                                })
                                .catch((error) => {
                                    console.error(error);
                                    alert(error);
                                })
                            }
                        })
                        itemMkdirElement.textContent = 'create directory';
                        itemElement.appendChild(itemMkdirElement);

                        fileListElement.appendChild(itemElement);
                    } else {

                        // List item container
                        var itemElement = document.createElement('div');
                        itemElement.classList = 'item';

                        // File type
                        if (item.is_file || item.is_dir) {
                            var itemTypeElement = document.createElement('div');
                            itemTypeElement.classList = item.is_file ? 'type file' : 'type dir';
                            itemTypeElement.textContent = item.is_file ? 'F' : 'D';
                            itemElement.appendChild(itemTypeElement);
                        }

                        if (item.is_file) {
                            // File with download
                            var itemNameElement = document.createElement('a');
                            itemNameElement.classList = 'name';
                            itemNameElement.href = `${ app.selfUrl }/download?path=${ encodeURIComponent(item.path) }`;
                            itemNameElement.target = '_blank';
                            itemNameElement.textContent = truncate(item.name, 32);
                            itemElement.appendChild(itemNameElement);

                            // Size info
                            var itemSizeElement = document.createElement('div');
                            itemSizeElement.classList = 'size';
                            itemSizeElement.target = '_blank';
                            itemSizeElement.textContent = humanFileSize(item.size);
                            itemElement.appendChild(itemSizeElement);
                        } else if (item.is_dir) {
                            // File with download
                            var itemNameElement = document.createElement('a');
                            itemNameElement.classList = 'name';
                            itemNameElement.href = `${ app.selfUrl }/?path=${ encodeURIComponent(item.path) }`;
                            itemNameElement.target = '_self';
                            itemNameElement.textContent = truncate(item.name, 32);
                            itemElement.appendChild(itemNameElement);
                        }

                        // Move button
                        var itemMkdirElement = document.createElement('div');
                        itemMkdirElement.classList = 'move fine-button green';
                        itemMkdirElement.addEventListener('click', function (event) {
                            var newPath = prompt(`Where to move ${ item.name }?`, item.path);
                            if (!newPath) {
                                return;
                            }

                            newPath = newPath.trim();
                            if (!newPath || newPath === app.path) {
                                return
                            }

                            if (event.button === 0) {
                                fetch(
                                    `${ app.selfUrl }/move?src_path=${ encodeURIComponent(item.path) }&dst_path=${ encodeURIComponent(newPath) }`,
                                    {
                                        'credentials': 'include',
                                    }
                                )
                                .then(async (response) => {
                                    if (response.status !== 200) {
                                        alert(response.statusText);
                                    } else {
                                        var json = await response.json();

                                        // Error
                                        if (json.error) {
                                            console.error(json.error);
                                            alert(json.error);
                                            return;
                                        }

                                        // Remove self
                                        updateFiles();
                                    }
                                })
                                .catch((error) => {
                                    console.error(error);
                                    alert(error);
                                })
                            }
                        })
                        itemMkdirElement.textContent = 'move';
                        itemElement.appendChild(itemMkdirElement);

                        // Delete button
                        var itemMkdirElement = document.createElement('div');
                        itemMkdirElement.classList = 'delete fine-button red';
                        itemMkdirElement.addEventListener('click', function (event) {
                            if (event.button === 0 && confirm(`Delete ${ item.name }?`)) {
                                fetch(
                                    `${ app.selfUrl }/delete?path=${ encodeURIComponent(item.path) }`,
                                    {
                                        'credentials': 'include',
                                    }
                                )
                                .then(async (response) => {
                                    if (response.status !== 200) {
                                        alert(response.statusText);
                                    } else {
                                        var json = await response.json();

                                        // Error
                                        if (json.error) {
                                            console.error(json.error);
                                            alert(json.error);
                                            return;
                                        }

                                        // Remove self
                                        fileListElement.removeChild(itemElement);
                                    }
                                })
                                .catch((error) => {
                                    console.error(error);
                                    alert(error);
                                })
                            }
                        })
                        itemMkdirElement.textContent = 'delete';
                        itemElement.appendChild(itemMkdirElement);

                        fileListElement.appendChild(itemElement);
                    }
                }

                /**
                 * Load files list from server and display
                 */
                function updateFiles() {
                    var fileListElement = document.getElementById('file-list');
                    fileListElement.innerHTML = '';

                    // Add move up item
                    addFileItem({ name: '..' });

                    // Request and add rest
                    fetchFilesList().then((files) => {
                        files.forEach(item => {
                            addFileItem(item);
                        });
                    })
                }


                /* UI things */

                /**
                 * Update path parameter in url
                 *
                 */
                function updateUrl() {
                    var pageUrl = new URL(window.location);
                    pageUrl.searchParams.set('path', app.path);
                };

                /**
                 * Update path in page title
                 */
                function updateTitle() {
                    document.title = `Xleb: ${ app.path }`;
                }


                /* Exit handler */

                window.onbeforeunload = function (e) {
                    if (app.uploading) {
                        e = e || window.event;

                        if (e) {
                            e.returnValue = 'Sure?';
                        }

                        return 'Sure?';
                    }
                };


                /* Startup UI */

                updateUrl();
                updateTitle();
                updateFiles();
            }) ();
        </script>
    </body>
</html>
