from bitcoin_usb.address_types import *
import pytest
from unittest.mock import patch
from bitcoin_usb.software_signer import SoftwareSigner

# test seeds
# seed1: spider manual inform reject arch raccoon betray moon document across main build
# seed2: similar seek stock parent depart rug adjust acoustic oppose sell roast hockey
# seed3: debris yellow child maze hen lamp law venue pluck ketchup melody sick


network = bdk.Network.REGTEST


def test_single_sig_spend():
    seed = "spider manual inform reject arch raccoon betray moon document across main build"

    psbt = "cHNidP8BAHECAAAAAX+OrD5rcUUUsYNLBWdcJjYG8TD9cfqttrEuG2Xj8PFgAAAAAAD9////AvNJXQUAAAAAFgAU9RChTmc3g0aRPVXDW3Pn+4BpcnyAlpgAAAAAABYAFCre0yWobi1cdShVshiOIFBiJzTDdgAAAE8BBDWHzwMyFoPCgAAAAJGLoVloEn3xJ2mtPtKTWFKeElFncZVq25u2pPBXiYyJA7ghwtM8sm2iyDZJuQsPpkPzv/Mz7WoCeW8ySg/cJZw4EHyF8rVUAACAAQAAgAAAAIAAAQBxAgAAAAHzye6Jjq/OfTShvE1mK4mPHq46TnLWXXl/Dst7HVD2CgAAAAAA/f///wIA4fUFAAAAABYAFI6GwbSN5egsC6wjpye0G9z6emxhcxAQJAEAAAAWABSdDWCaRKCzjBdtdrhQmWCAuiY/CAAAAAABAR8A4fUFAAAAABYAFI6GwbSN5egsC6wjpye0G9z6emxhAQMEAQAAACIGAmwUkzrL/GENve6WmL8kg0lNdhSHdIKe4dJjuO281HCZGHyF8rVUAACAAQAAgAAAAIAAAAAAAAAAAAAiAgNdIY795pswZFA83q0cM9XbgmXl8MU29aseHqtv7+wGzBh8hfK1VAAAgAEAAIAAAACAAQAAAAAAAAAAIgIDJE38dFQK12Q+UlcjOn+X/fHGcm84ablxHKI56Qr6t+0YfIXytVQAAIABAACAAAAAgAAAAAABAAAAAA=="

    software_signer = SoftwareSigner(seed, network)
    signed_psbt = software_signer.sign_psbt(bdk.PartiallySignedTransaction(psbt))

    assert (
        signed_psbt.serialize()
        == "cHNidP8BAHECAAAAAX+OrD5rcUUUsYNLBWdcJjYG8TD9cfqttrEuG2Xj8PFgAAAAAAD9////AvNJXQUAAAAAFgAU9RChTmc3g0aRPVXDW3Pn+4BpcnyAlpgAAAAAABYAFCre0yWobi1cdShVshiOIFBiJzTDdgAAAE8BBDWHzwMyFoPCgAAAAJGLoVloEn3xJ2mtPtKTWFKeElFncZVq25u2pPBXiYyJA7ghwtM8sm2iyDZJuQsPpkPzv/Mz7WoCeW8ySg/cJZw4EHyF8rVUAACAAQAAgAAAAIAAAQBxAgAAAAHzye6Jjq/OfTShvE1mK4mPHq46TnLWXXl/Dst7HVD2CgAAAAAA/f///wIA4fUFAAAAABYAFI6GwbSN5egsC6wjpye0G9z6emxhcxAQJAEAAAAWABSdDWCaRKCzjBdtdrhQmWCAuiY/CAAAAAABAR8A4fUFAAAAABYAFI6GwbSN5egsC6wjpye0G9z6emxhAQhrAkcwRAIgbZS9PecHX4GhPQCdcYv4mbXkuKmypAlQSDCDmY8k0AECIGA3WVj1VfZF2xSdMJnFO/CUXMOyfqG2tvlNMZoRVusjASECbBSTOsv8YQ297paYvySDSU12FId0gp7h0mO47bzUcJkAIgIDXSGO/eabMGRQPN6tHDPV24Jl5fDFNvWrHh6rb+/sBswYfIXytVQAAIABAACAAAAAgAEAAAAAAAAAACICAyRN/HRUCtdkPlJXIzp/l/3xxnJvOGm5cRyiOekK+rftGHyF8rVUAACAAQAAgAAAAIAAAAAAAQAAAAA="
    )
    logger.info(signed_psbt.serialize())


def test_single_multisig_sign():
    seed = "spider manual inform reject arch raccoon betray moon document across main build"

    psbt = "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"

    software_signer = SoftwareSigner(seed, network)
    signed_psbt = software_signer.sign_psbt(bdk.PartiallySignedTransaction(psbt))

    assert (
        signed_psbt.serialize()
        == "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"
    )
    logger.info(signed_psbt.serialize())

    # now sign with 2. key
    seed = (
        "similar seek stock parent depart rug adjust acoustic oppose sell roast hockey"
    )

    psbt = signed_psbt.serialize()

    software_signer = SoftwareSigner(seed, network)
    signed_psbt = software_signer.sign_psbt(bdk.PartiallySignedTransaction(psbt))

    assert (
        bytes(signed_psbt.extract_tx().serialize()).hex()
        == "020000000001017f0fc37ab8e747ecec50636e036ab11a0aeacbacc65cc173d1d7a30bbd0fdf840100000000fdffffff0289b4fa0200000000220020ab8fb4f56961bea3e57230972d8ca3370d867c19b751daf04906ad8f561f2fb9005a620200000000220020b2a19f1275b630ae74a74230bd3d05c790e0ce40f7a7df1f700c5cdca3e6490604004730440220545f5469bd22acf497de4a44cbc3208e634375eaefd1246581dc7741801d2f690220026ca2860ad9b11f944b4b366a2cdc328a263cef4d117894b045834b9eddc5e8014730440220702cc498c129b16ce03d91ff2088027760050df007d77748b5088e80f8168adf02205d297ee21ad0e035d97e861248ddc5fa997c87180743268cd99a1d3f1ee10bd70169522102b441a02b3e0260e11c387102bba1858ca9dcc4acfe18e742d351f3b285743c1b21030968c9f2a948fdba8d64c90db4b66048eb973c8c1be67d01bab6a26a1d4ab3dd21037865f63c378832d60ced3fe7205685356f2eee244fbf5ab0c5c4d91b2d3aadcc53ae79000000"
    )
