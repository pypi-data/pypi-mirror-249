import json
import unittest

from paik2json.line_manager import LineManager
from paik2json.parser import Parser


raw_ë©”ëª¨_ì˜ˆì‹œ1 = """day-2023-12-27-D0
  ì¼ì¼ë³´ê³ -D1
    í•œì¼-D2
      ë¬¸ì„œ ì“°ê¸°
      ì½”ë“œ ì§œê¸°
    í• ì¼-D2
      ë¬¸ì„œ ì½ê¸°
      ì½”ë“œ ì‹¤í–‰í•˜ê¸°
  í† í”½1-D1
    í• ì¼1-D2
      ë­”ê°€ í•´ì•¼í•¨
      í•  ê²Œ ë§ìŒ
    í• ì¼2-D2
    í• ì¼3-D2
  í† í”½2-D1
    í•  ê²Œ ë³„ë¡œ ì—†ìŒ-D2
    í• ì¼4-D2
"""

raw_ë©”ëª¨_ì˜ˆì‹œ2 = """2023-12-28(ëª©)
  did
    ğŸ•¹ï¸ [ABC-1] ì±…ì¥ ì •ë¦¬í•˜ê¸°
    ğŸ•¹ï¸ [ABC-12] ê²€ìƒ‰ í¼ ìƒì„±
  willdo
    ğŸ•¹ï¸ [ABC-123] ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€
    ğŸ•¹ï¸ [ABC-1234] ì±… ë“±ë¡í•˜ê¸°

  ğŸ•¹ï¸ [ABC-123] ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€
    í•˜ë‚˜ì”© ì²˜ë¦¬
    ë‘ê°œì”© ì²˜ë¦¬
    ì„¸ê°œì”© ì²˜ë¦¬

2023-12-27(ìˆ˜)
  did
    ğŸ•¹ï¸ [ABC-9] ì±…ì¥ êµ¬ìƒí•˜ê¸°
    ğŸ•¹ï¸ íœ´ê°€
  willdo
    ğŸ•¹ï¸ [ABC-1] ì±…ì¥ ì •ë¦¬í•˜ê¸°
    ğŸ•¹ï¸ [ABC-12] ê²€ìƒ‰ í¼ ìƒì„±

  ğŸ•¹ï¸ [ABC-12] ê²€ìƒ‰ í¼ ìƒì„±
    ê²€ìƒ‰ í¼ UI ì œì‘
    ë°˜ì‘í˜• ì ìš©
"""


class ParserTestCase(unittest.TestCase):
    def setUp(self):
        self.parser1 = Parser(LineManager(raw_ë©”ëª¨_ì˜ˆì‹œ1))
        self.parser2 = Parser(LineManager(raw_ë©”ëª¨_ì˜ˆì‹œ2))
        self.maxDiff = None

    def test_parse_hook_ìœ¼ë¡œ_ë¬¸ìì—´ì„_ë³€ê²½í• _ìˆ˜_ìˆë‹¤(self):
        expected1 = json.loads(
            """{"2023-12-28(ëª©)â­ï¸": {"didâ­ï¸": {"ğŸ•¹ï¸ [ABC-1] ì±…ì¥ ì •ë¦¬í•˜ê¸°â­ï¸": {}, "ğŸ•¹ï¸ [ABC-12] ê²€ìƒ‰ í¼ ìƒì„±â­ï¸": {}}, "willdoâ­ï¸": {"ğŸ•¹ï¸ [ABC-123] ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€â­ï¸": {}, "ğŸ•¹ï¸ [ABC-1234] ì±… ë“±ë¡í•˜ê¸°â­ï¸": {}}, "ğŸ•¹ï¸ [ABC-123] ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€â­ï¸": {"í•˜ë‚˜ì”© ì²˜ë¦¬â­ï¸": {}, "ë‘ê°œì”© ì²˜ë¦¬â­ï¸": {}, "ì„¸ê°œì”© ì²˜ë¦¬â­ï¸": {}}}, "2023-12-27(ìˆ˜)â­ï¸": {"didâ­ï¸": {"ğŸ•¹ï¸ [ABC-9] ì±…ì¥ êµ¬ìƒí•˜ê¸°â­ï¸": {}, "ğŸ•¹ï¸ íœ´ê°€â­ï¸": {}}, "willdoâ­ï¸": {"ğŸ•¹ï¸ [ABC-1] ì±…ì¥ ì •ë¦¬í•˜ê¸°â­ï¸": {}, "ğŸ•¹ï¸ [ABC-12] ê²€ìƒ‰ í¼ ìƒì„±â­ï¸": {}}, "ğŸ•¹ï¸ [ABC-12] ê²€ìƒ‰ í¼ ìƒì„±â­ï¸": {"ê²€ìƒ‰ í¼ UI ì œì‘â­ï¸": {}, "ë°˜ì‘í˜• ì ìš©â­ï¸"
            : {}}}}"""
        )
        result1 = Parser(LineManager(raw_ë©”ëª¨_ì˜ˆì‹œ2), hook=(lambda x: x + "â­ï¸")).parse()
        self.assertDictEqual(expected1, result1)

        expected2 = json.loads(
            """{"2023-12-28(ëª©)": {"did": {"ğŸ•¹ï¸ [DEF-1] ì±…ì¥ ì •ë¦¬í•˜ê¸°": {}, "ğŸ•¹ï¸ [DEF-12] ê²€ìƒ‰ í¼ ìƒì„±": {}}, "willdo": {"ğŸ•¹ï¸ [DEF-123] ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€": {}, "ğŸ•¹ï¸ [DEF-1234] ì±… ë“±ë¡í•˜ê¸°": {}}, "ğŸ•¹ï¸ [DEF-123] ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€": {"í•˜ë‚˜ì”© ì²˜ë¦¬": {}, "ë‘ê°œì”© ì²˜ë¦¬": {}, "ì„¸ê°œì”© ì²˜ë¦¬": {}}}, "2023-12-27(ìˆ˜)": {"did": {"ğŸ•¹ï¸ [DEF-9] ì±…ì¥ êµ¬ìƒí•˜ê¸°": {}, "ğŸ•¹ï¸ íœ´ê°€": {}}, "willdo": {"ğŸ•¹ï¸ [DEF-1] ì±…ì¥ ì •ë¦¬í•˜ê¸°": {}, "ğŸ•¹ï¸ [DEF-12] ê²€ìƒ‰ í¼ ìƒì„±": {}}, "ğŸ•¹ï¸ [DEF-12] ê²€ìƒ‰ í¼ ìƒì„±": {"ê²€ìƒ‰ í¼ UI ì œì‘": {}, "ë°˜ì‘í˜• ì ìš©"
            : {}}}}"""
        )
        result2 = Parser(
            LineManager(raw_ë©”ëª¨_ì˜ˆì‹œ2), hook=(lambda x: x.replace("ABC", "DEF"))
        ).parse()
        self.assertDictEqual(expected2, result2)

    def test_parse_ë¡œ_í…Œì´ë¸”ì„_JSON_ìœ¼ë¡œ_ë³€ê²½í• _ìˆ˜_ìˆë‹¤(self):
        expected1 = {
            "day-2023-12-27-D0": {
                "ì¼ì¼ë³´ê³ -D1": {
                    "í•œì¼-D2": {"ë¬¸ì„œ ì“°ê¸°": {}, "ì½”ë“œ ì§œê¸°": {}},
                    "í• ì¼-D2": {"ë¬¸ì„œ ì½ê¸°": {}, "ì½”ë“œ ì‹¤í–‰í•˜ê¸°": {}},
                },
                "í† í”½1-D1": {
                    "í• ì¼1-D2": {"ë­”ê°€ í•´ì•¼í•¨": {}, "í•  ê²Œ ë§ìŒ": {}},
                    "í• ì¼2-D2": {},
                    "í• ì¼3-D2": {},
                },
                "í† í”½2-D1": {"í•  ê²Œ ë³„ë¡œ ì—†ìŒ-D2": {}, "í• ì¼4-D2": {}},
            }
        }
        result1 = self.parser1.parse()
        self.assertDictEqual(expected1, result1)

        expected2 = json.loads(
            """{"2023-12-28(ëª©)": {"did": {"ğŸ•¹ï¸ [ABC-1] ì±…ì¥ ì •ë¦¬í•˜ê¸°": {}, "ğŸ•¹ï¸ [ABC-12] ê²€ìƒ‰ í¼ ìƒì„±": {}}, "willdo": {"ğŸ•¹ï¸ [ABC-123] ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€": {}, "ğŸ•¹ï¸ [ABC-1234] ì±… ë“±ë¡í•˜ê¸°": {}}, "ğŸ•¹ï¸ [ABC-123] ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€": {"í•˜ë‚˜ì”© ì²˜ë¦¬": {}, "ë‘ê°œì”© ì²˜ë¦¬": {}, "ì„¸ê°œì”© ì²˜ë¦¬": {}}}, "2023-12-27(ìˆ˜)": {"did": {"ğŸ•¹ï¸ [ABC-9] ì±…ì¥ êµ¬ìƒí•˜ê¸°": {}, "ğŸ•¹ï¸ íœ´ê°€": {}}, "willdo": {"ğŸ•¹ï¸ [ABC-1] ì±…ì¥ ì •ë¦¬í•˜ê¸°": {}, "ğŸ•¹ï¸ [ABC-12] ê²€ìƒ‰ í¼ ìƒì„±": {}}, "ğŸ•¹ï¸ [ABC-12] ê²€ìƒ‰ í¼ ìƒì„±": {"ê²€ìƒ‰ í¼ UI ì œì‘": {}, "ë°˜ì‘í˜• ì ìš©"
            : {}}}}"""
        )
        result2 = self.parser2.parse()
        self.assertDictEqual(expected2, result2)
